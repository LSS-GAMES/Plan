<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Админка — заявки</title>
  <style>
    :root{
      --bg:#f6f7f9; --card:#ffffff; --panel:#ffffff; --muted:#6b7280; --text:#0f172a; --border:#e5e7eb;
      --accent:#2563eb; --accent-contrast:#ffffff; --ring:0 0 0 3px rgba(37,99,235,.25);
      font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:1120px;margin:24px auto 80px;padding:0 16px}
    @supports(padding:max(0px)){.wrap{padding-left:max(16px,env(safe-area-inset-left));padding-right:max(16px,env(safe-area-inset-right))}}

    .card{background:var(--card);border:1px solid var(--border);box-shadow:0 6px 24px rgba(15,23,42,.06);border-radius:16px}
    .login{max-width:520px;margin:56px auto;padding:22px}
    h1{font-size:22px;margin:0 0 12px}
    .muted{color:var(--muted);font-size:13px}
    .row{display:grid;gap:6px;margin:10px 0}
    input[type=email],input[type=password],select,input[type=text]{background:#fff;border:1px solid var(--border);border-radius:12px;padding:11px 12px;color:var(--text);width:100%}
    input:focus,select:focus{outline:none;box-shadow:var(--ring);border-color:#93c5fd}
    button{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn{background:var(--accent);color:var(--accent-contrast);box-shadow:0 6px 18px rgba(37,99,235,.25)}
    .btn.secondary{background:#fff;color:var(--text);border:1px solid var(--border);box-shadow:none}

    .header{display:flex;justify-content:space-between;align-items:center;padding:14px 14px 0}
    .header h2{margin:0;font-size:18px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;padding:14px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--panel);border-radius:16px 16px 0 0;z-index:5}
    .hint{font-size:12px;color:var(--muted)}

    .table-wrap{overflow:auto; -webkit-overflow-scrolling:touch; max-height:70vh; border-top:1px solid var(--border)}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:var(--panel);z-index:2;border-bottom:1px solid var(--border)}
    th,td{font-size:13px;padding:10px 12px;vertical-align:top;border-bottom:1px solid var(--border)}
    .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px}

    .status{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;padding:10px 14px;border-radius:12px;background:#111827;color:#fff;border:1px solid rgba(0,0,0,.08);display:none;box-shadow:0 10px 30px rgba(0,0,0,.15)}
    .status.ok{background:#065f46}
    .status.err{background:#b91c1c}

    .right{justify-self:end;display:flex;gap:10px;align-items:center}
    @media(min-width:900px){.split{grid-template-columns:1fr auto}}
  </style>
</head>
<body>
  <div class="wrap">
    <div id="login" class="card login">
      <h1>Вход для администраторов</h1>
      <p class="muted">Войдите учёткой Supabase (email+password). Доступ выдаётся только доверенным адресам.</p>
      <div class="row"><label>Email</label><input id="email" type="email" autocomplete="email" /></div>
      <div class="row"><label>Пароль</label><input id="password" type="password" autocomplete="current-password" /></div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <button id="btnLogin" class="btn">Войти</button>
        <button id="btnLogoutHidden" class="btn secondary" style="display:none">Выйти</button>
        <span class="muted">Нужен доступ? Добавьте пользователя в Supabase Auth и в политику RLS.</span>
      </div>
    </div>

    <section id="app" class="card" style="display:none">
      <div class="header">
        <h2>Заявки</h2>
        <div class="right">
          <button id="btnExport" class="btn secondary">Экспорт CSV</button>
          <button id="btnLogout" class="btn secondary">Выйти</button>
        </div>
      </div>
      <div class="toolbar">
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <select id="filterDate">
            <option value="">Все даты</option>
            <option value="2025-11-19">19 ноября</option>
            <option value="2025-11-20">20 ноября</option>
            <option value="2025-11-21">21 ноября</option>
          </select>
          <select id="filterTime">
            <option value="">Все часы</option>
            <option>09:00</option><option>10:00</option><option>11:00</option><option>12:00</option>
            <option>13:00</option><option>14:00</option><option>15:00</option><option>16:00</option><option>17:00</option>
          </select>
          <input id="search" type="text" placeholder="Поиск: организация, руководитель, команда..." />
          <button id="btnRefresh" class="btn">Обновить</button>
        </div>
        <div class="hint">Показываются только записи, доступ к которым разрешён политиками RLS.</div>
      </div>

      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>Дата</th>
              <th>Время</th>
              <th>Категория</th>
              <th>Организация</th>
              <th>Руководитель</th>
              <th>Должность</th>
              <th>Телефон</th>
              <th>Email</th>
              <th>Команда</th>
              <th>Участник 1 (ДР)</th>
              <th>Участник 2 (ДР)</th>
              <th>Участник 3 (ДР)</th>
              <th>Создано</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <div id="status" class="status" role="status" aria-live="polite"></div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // === ВСТАВЬТЕ СВОИ ЗНАЧЕНИЯ (строго в двойных кавычках, всё на одной строке) ===
    const SUPABASE_URL = "https://wjoldaptaecqfworfkzk.supabase.co"; // твой Project URL
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indqb2xkYXB0YWVjcWZ3b3Jma3prIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNzQ0OTEsImV4cCI6MjA3Nzk1MDQ5MX0.-sQLLELT8xq_xYX1INTZE_Q2bzoxEOEoPwcSotIKryE"; // public anon

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ——— Настройки экспорта
    const COLUMNS = [
      'created_at','event_date','event_time','age_category','org','leader_name','position','phone','email',
      'team_name','member1_name','member1_birth','member2_name','member2_birth','member3_name','member3_birth'
    ];
    const SELECT_LIST = COLUMNS.join(',');

    const elLogin = document.getElementById('login');
    const elApp = document.getElementById('app');
    const email = document.getElementById('email');
    const password = document.getElementById('password');
    const statusEl = document.getElementById('status');

    function toast(msg, ok){
      statusEl.textContent = msg;
      statusEl.className = 'status ' + (ok?'ok':'err');
      statusEl.style.display = 'block';
      clearTimeout(toast._t);
      toast._t = setTimeout(function(){ statusEl.style.display = 'none'; }, 3500);
    }

    function fmtDate(d){ if(!d) return ''; var x = new Date(d); return isNaN(x) ? d : x.toLocaleDateString('ru-RU'); }
    function fmtTime(t){ return (t||'').slice(0,5); }

    async function signIn(){
      const creds = { email: (email.value||'').trim(), password: password.value||'' };
      const { error } = await supabase.auth.signInWithPassword(creds);
      if (error) { toast('Ошибка входа: ' + (error.message||'проверьте доступ'), false); return; }
      email.value=''; password.value='';
      await load();
      elLogin.style.display='none'; elApp.style.display='block';
    }

    async function signOut(){
      await supabase.auth.signOut();
      elApp.style.display='none'; elLogin.style.display='block';
    }

    async function load(){
      const d = document.getElementById('filterDate').value;
      const t = document.getElementById('filterTime').value;
      const q = (document.getElementById('search').value||'').trim().toLowerCase();

      let query = supabase
        .from('bookings')
        .select(SELECT_LIST)
        .order('event_date')
        .order('event_time');
      if (d) query = query.eq('event_date', d);
      if (t) query = query.eq('event_time', t);

      const { data, error } = await query;
      if (error) { toast('Нет доступа или ошибка загрузки', false); console.error(error); return; }

      const rows = (data||[]).filter(function(r){
        const hay = (r.org + ' ' + r.leader_name + ' ' + r.team_name).toLowerCase();
        return !q || hay.includes(q);
      });

      const tb = document.querySelector('#tbl tbody');
      tb.innerHTML = '';
      for (let i=0;i<rows.length;i++){
        const r = rows[i];
        const html = [
          '<td>', fmtDate(r.event_date), '</td>',
          '<td><span class="pill">', fmtTime(r.event_time), '</span></td>',
          '<td>', r.age_category||'', '</td>',
          '<td>', r.org||'', '</td>',
          '<td>', r.leader_name||'', '</td>',
          '<td>', r.position||'', '</td>',
          '<td>', r.phone||'', '</td>',
          '<td>', r.email||'', '</td>',
          '<td>', r.team_name||'', '</td>',
          '<td>', r.member1_name||'', ' (', fmtDate(r.member1_birth), ')</td>',
          '<td>', r.member2_name||'', ' (', fmtDate(r.member2_birth), ')</td>',
          '<td>', r.member3_name||'', ' (', fmtDate(r.member3_birth), ')</td>',
          '<td>', new Date(r.created_at).toLocaleString('ru-RU'), '</td>'
        ].join('');
        const tr = document.createElement('tr');
        tr.innerHTML = html;
        tb.appendChild(tr);
      }
      toast('Загружено: ' + rows.length, true);
    }

    // —— CSV: автоопределение разделителя по локали и стабильный порядок колонок
    function detectCsvSep(){
      try {
        // Если десятичный разделитель — запятая, то для CSV берём ; (классическая ру-локаль)
        return (1.1).toLocaleString().includes(',') ? ';' : ',';
      } catch {
        return ';';
      }
    }

    function toCSV(rows, columns, sep){
      if (!rows || !rows.length) return '';
      sep = sep || detectCsvSep();
      const esc = v => '"' + String(v ?? '').replace(/"/g,'""') + '"';

      const lines = [];
      // Подсказка Excel каков разделитель
      lines.push('sep=' + sep);
      lines.push(columns.map(esc).join(sep)); // заголовки — в виде ключей

      for (const r of rows){
        lines.push(columns.map(k => esc(r[k])).join(sep));
      }
      return lines.join('\n');
    }

    async function exportCSV(){
      let query = supabase
        .from('bookings')
        .select(SELECT_LIST)
        .order('event_date')
        .order('event_time');

      const d = document.getElementById('filterDate').value; if (d) query = query.eq('event_date', d);
      const t = document.getElementById('filterTime').value; if (t) query = query.eq('event_time', t);

      const { data, error } = await query;
      if (error) { toast('Экспорт недоступен', false); return; }

      const sep = detectCsvSep();
      const csv = toCSV(data || [], COLUMNS, sep);

      // BOM перед первым символом (до 'sep=...') — чтобы Excel увидел UTF-8
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const dt = new Date().toISOString().slice(0,10);
      a.download = 'bookings_' + dt + '.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // Восстановление сессии
    supabase.auth.getSession().then(function(res){
      if (res && res.data && res.data.session) { elLogin.style.display='none'; elApp.style.display='block'; load(); }
    });

    // Слушатели
    document.getElementById('btnLogin').addEventListener('click', signIn);
    document.getElementById('btnLogout').addEventListener('click', signOut);
    document.getElementById('btnLogoutHidden').addEventListener('click', signOut);
    document.getElementById('btnRefresh').addEventListener('click', load);
    document.getElementById('btnExport').addEventListener('click', exportCSV);

    document.getElementById('filterDate').addEventListener('change', load);
    document.getElementById('filterTime').addEventListener('change', load);
    document.getElementById('search').addEventListener('input', function(){ clearTimeout(window._t); window._t=setTimeout(load,250); });

    // Enter для логина
    document.addEventListener('keydown', (e)=>{
      if (elLogin.style.display!=='none' && (e.key==='Enter')) signIn();
    });
  </script>
</body>
</html>
